@using Winkompass_Mobil.Helpers;
@model ScanItemModel
@section title{
    Winkompass quick scan
}



@section siteHeader{
    Quick scan
}
<div class="element left tinyBotSpace @((SessionManager.Manager.Responsive is html5 ? "text-primary" : ""))" id="result"><b id="actionMessageLabel">Status:</b> <span id="actionMessage">Afventer scanning</span></div>
<div class="left element tinyBotSpace"><span>Scan stregkode</span></div>
<form method="post" id="quickForm">
    <input type="text" class="elementInputHack" id="scanInput" name="item.barCode" />
    @*<div class="element left">Manuel Indtastning <input type="checkbox" name="mo<!--Manual override-->" id="mo" /></div>*@
</form>
@*<div class="element left tinyBotSpace"><b>Status:</b> <font id="actionMessage">Afventer scanning</font></div>*@
<div id="Result">@Html.Action(MVC.Storage.Top5(Url.RequestContext.RouteData.Values["id"].ToString()))</div>

@*@if (Model != null && !string.IsNullOrEmpty(Model.Error))
    {
        <div class="element left tinyBotSpace"><font>@Model.Error</font></div>
    }
    else if (Model != null && Model.scanned == BE.ScanItem.SCAN_VALID)
    {
        <div class="element left tinyBotSpace"><font>Scanning registreret!</font></div>
    }
    else if (Model != null && Model.scanned == BE.ScanItem.SCAN_INVALID)
    {
        <div class="element left tinyBotSpace"><font>Scanning fejlede ved registrering!</font></div>
    }*@

@section BottomScripts {
    <script type="text/javascript">

        function showMessage(message, SColor) {


            @if(SessionManager.Manager.Responsive is html5)
            {
            <text>
            document.getElementById('actionMessage').textContent = message;
            document.getElementById('result').classList.remove("text-info");
            document.getElementById('result').classList.add(SColor);
            </text>
            }
            else
            {
            <text>
            document.getElementById('actionMessage').innerText = message;
            </text>
            }
            setTimeout(function () {
                @if(SessionManager.Manager.Responsive is html5)
                {
                <text>
                document.getElementById('result').classList.remove(SColor);
                document.getElementById('result').classList.add("text-info");
                document.getElementById('actionMessage').textContent = "Afventer scanning";
                </text>
                }
            else
            {
                <text>
                document.getElementById('actionMessage').innerText = "Afventer scanning";
                </text>
            }
               
            }, 4000);
        }
        $("#scanInput").bind("keypress", function (e) {
            if (e.keyCode == 13) {
                $("#scanInput").disabled = true;
                var ScanItemModel = { item: { barCode: document.getElementById('scanInput').value } };
                $.ajax({
                    url: '@Url.Action(MVC.Storage.QuickCount(Url.RequestContext.RouteData.Values["id"].ToString()))',
                    async: true,
                    type: 'POST',
                    dataType: 'json',
                    data: JSON.stringify(ScanItemModel),
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        var message = "";
                        var SColor = "text-success";
                        if (data.scanned != 1) {
                            message += data.Error;
                            SColor = "text-danger";
                        }
                        else {
                            message += "Scanning registreret: " + data.item.barCode;

                            updateTable();


                        }
                        showMessage(message, SColor);
                    }
                });
                document.getElementById('scanInput').value = "";
                $('#scanInput').disabled = false;
                return false;
            }
        });@*
    function httpGet(location, cb) {
        var xhr;
        if (window.XMLHttpRequest) {
            xhr = new XMLHttpRequest();
        }
        else if (window.ActiveXObject) {
            xhr = new ActiveXObject("Microsoft.XMLHTTP");
        }

        xhr.onreadystatechange = function (event) {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    cb(xhr.responseText);
                }
            }
        };
        xhr.open("GET", location, true);
        //xhr.channel.loadFlags |= Components.interface.nsIRequest.LOAD_BYPASS_CACHE;
        xhr.setRequestHeader("Expires", "Mon, 1 Jan 1990 00:00:00 GMT");
        xhr.setRequestHeader("Cache-Control: private", "max-age=0");
        xhr.setRequestHeader("Pragma", "no-cache");

        xhr.send("");
    }*@
        function updateTable() {@*$.get('@Url.Action(MVC.Storage.Top5(Url.RequestContext.RouteData.Values["id"].ToString()))', null, function (tableData) {
            document.getElementById('Result').innerHTML = tableData;
            return false;
        });


            httpGet('@Url.Action(MVC.Storage.Top5(Url.RequestContext.RouteData.Values["id"].ToString()))', function (tableData) {
                alert(tableData);
                document.getElementById('Result').innerHTML = tableData;
            });*@
            $.ajax({
                url: '@Url.Action(MVC.Storage.Top5(Url.RequestContext.RouteData.Values["id"].ToString()))',
                type: 'GET',
                dataType: 'html',
                contentType: 'text; charset=utf-8',
                cache: false,
                success: function (tableData) {
                    @*alert(tableData);
                    alert(''+@Url.Action(MVC.Storage.Top5(Url.RequestContext.RouteData.Values["id"].ToString())));
                    document.getElementById('Result').innerHTML = "";

                    alert(tableData);*@
                    $('#Result').html(tableData);

                }
            });
        }
        @* $('#quickForm').submit(function () {
        $("#scanInput").disabled = true;
        var ScanItemModel = { item: { barCode: document.getElementById('scanInput').value } };
        $.ajax({
            url: '@Url.Action(MVC.Storage.QuickCount(Url.RequestContext.RouteData.Values["id"].ToString()))',
            async: true,
            type: 'POST',
            dataType: 'json',
            data: JSON.stringify(ScanItemModel),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var message = "Status: ";
                if (data.scanned != 1)
                { message += data.Error; }
                else
                {
                    message += "Scanning registreret: " + data.item.barCode;

                    updateTable();


                }
                showMessage(message);
            }
        });
        document.getElementById('scanInput').value = "";
        $('#scanInput').disabled = false;
        return false;
    });*@
        $(window).load(function () {
            $("#scanInput").focus();
        });
    </script>}